#!/bin/bash

MENU="fuzzel -d --prompt"

declare -a action
action+=(
    copy
    save
    copysave
)

declare -a zone
zone+=(
    area
    window
    active
    output
    screen
)

declare -a option
option+=(
    edit
    img2txt
)

declare -a choice
choice+=(
    yes
    no
)

createmenu(){
    list=("$1")
    printf "%s\n" "${list[@]}" | $MENU "$2"
}

paint(){
    CHOICE=$( createmenu "${choice[*]}" "Replace original? " )
    die "$CHOICE"

    [ "$CHOICE" = "yes" ] && FLAGS="--output-file '${FN}'"
    
    if [ "$ACTION" = "copy" ]; then
        wl-paste | swappy -f - "$FLAGS"
    else
        swappy -f "$FN" "$FLAGS"
    fi

    # TODO: parse filename to modify only last part name
    # [ $FLAGS ] && mv 
}

grabtext(){
    if [ "$ACTION" = "copy" ]; then
        wl-paste | tesseract stdin stdout | wl-copy
    else
        tesseract "$FN" stdout | wl-copy
    fi

    notify-send "Converted!" "Text saved in clipboard"
}

die(){
    test -z "$1" && notify-send "But nothing happened!" && exit 1
}

ACTION=$( createmenu "${action[*]}" "Screenshot: " )
die "$ACTION"

[ "$ACTION" != "copy" ] && option+=( "path" )

ZONE=$( createmenu "${zone[*]}" "What to grab: " )
die "$ZONE"

[ "$ZONE" = active ] || [ "$ZONE" = output ] || [ "$ZONE" = screen ] && sleep 1

FN=$( grimblast --notify "$ACTION" "$ZONE" ) || die

OPT=$( createmenu "${option[*]}" "Do you want to do everything else? " )
die "$OPT"

case $OPT in
    edit) paint ;;
    img2txt) grabtext ;;
    path) wl-copy "$FN" && notify-send "Success!" "path file saved in clipboard" ;;
    *) die;;
esac
