#!/bin/sh

err(){
    dunstify "But nothing happened!"
    exit 1
}

SAVEPATH="$HOME/Pictures/Screenshots"
SAVENAME="$(date "+%Y%m%d-%H%M%S").png"

VIEW=imv

test $XDG_SESSION_TYPE = "wayland" # 0 if it's true
WL=$?

if ! ( $WL ); then
    MENU="wofi -d"
    CMD="grim"
    AREA="slurp"
else
    MENU="dmenu"
    CMD="shotgun"
    AREA="hacksaw"
fi

OPT=$(echo -e "-Crop\n-Fullscreen" | $MENU --prompt "Screenshot:")

# here starts
case $OPT in
    "-Crop") CROP=1;;
    "-Fullscreen") CROP=0;;
    *) err ;;
esac

SAVE=$(echo -e "-Clipboard\n-Save\n-Img2Txt" | $MENU)
if [ $SAVE ]; then # TODO: should be improved without checking CROP check
    (($CROP)) && 
        $CMD -g "$($AREA)" $SAVEPATH/$SAVENAME || 
        $CMD $SAVEPATH/$SAVENAME
fi

case $SAVE in
    "-Save")
        CHANGE=$(echo -e "No\nYes" | $MENU --prompt "Change image's name?")
        [ $CHANGE = "Yes" ] && NEW=$(echo -e "" | $MENU --prompt "New name:")

        if [ $NEW ]; then
            COUNT=$(ls $SAVEPATH | grep $NEW | wc -l)
            [ $COUNT -gt 0 ] && NEW+=($COUNT).png || NEW+=.png
            mv $SAVEPATH/$SAVENAME $SAVEPATH/$NEW && SAVENAME=$NEW
        fi

        ACTION=$( dunstify "Capture Saved!" "$SAVENAME saved in $SAVEPATH" \
            -i $SAVEPATH/$SAVENAME \
            --action="show, image viewer" \
            --action="list, file manager" ) #TODO
        case $ACTION in
            show) $VIEW $SAVEPATH/$SAVENAME ;;
            list) $TERMINAL -e lf $SAVEPATH ;;
            *) err ;;
        esac
        ;;

    "-Clipboard")
        test $XDG_SESSION_TYPE = "wayland" &&
            wl-copy < $SAVEPATH/$SAVENAME || 
            xclip -selection clipboard -t image/png $SAVEPATH/$SAVENAME

        dunstify "Screenshot saved in the clipboard!" -i $SAVEPATH/$SAVENAME
        rm $SAVEPATH/$SAVENAME
        ;;

    "-Img2Txt")
        tesseract -l ita+eng $SAVEPATH/$SAVENAME stdout | wl-copy

        dunstify "Extracted text from image!" "Stored result in clipboard" -i xclipboard
        rm $SAVEPATH/$SAVENAME
        ;;

    *) err ;;
esac
